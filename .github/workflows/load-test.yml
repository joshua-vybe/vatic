name: Load Test

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday 2am UTC

jobs:
  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Locust
        run: pip install locust
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      
      - name: Get staging URL
        id: staging-url
        run: |
          STAGING_URL=$(aws cloudformation describe-stacks \
            --stack-name vatic-prop-staging \
            --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerURL`].OutputValue' \
            --output text)
          echo "url=$STAGING_URL" >> $GITHUB_OUTPUT
      
      - name: Run load tests
        run: |
          cd backend/tests/load
          chmod +x run-load-tests.sh
          ./run-load-tests.sh ${{ steps.staging-url.outputs.url }}
      
      - name: Upload results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: load-test-results
          path: backend/tests/load/results/
          retention-days: 30
      
      - name: Parse results
        if: always()
        run: |
          echo "## Load Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenario 1: Ramp-up Test" >> $GITHUB_STEP_SUMMARY
          echo "- Target: 1,000 concurrent users over 5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Target Metrics: p99 <10ms, error rate <0.1%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenario 2: Sustained Load" >> $GITHUB_STEP_SUMMARY
          echo "- Target: 10,000 orders/sec for 5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- Target Metrics: p99 <10ms, error rate <0.1%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenario 3: Spike Test" >> $GITHUB_STEP_SUMMARY
          echo "- Target: 0 → 5,000 users in 30 seconds" >> $GITHUB_STEP_SUMMARY
          echo "- Target Metrics: p99 <15ms, error rate <1%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenario 4: Stress Test" >> $GITHUB_STEP_SUMMARY
          echo "- Target: Identify breaking point" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Results saved to artifacts" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '❌ Load test failed. Check artifacts for details.'
            })
