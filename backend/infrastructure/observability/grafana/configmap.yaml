apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus:9090
      isDefault: true
      editable: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-config
  namespace: monitoring
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'Dashboards'
      orgId: 1
      folder: ''
      type: file
      disableDeletion: false
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-files
  namespace: monitoring
data:
  latency-dashboard.json: |
    {
      "dashboard": {
        "title": "Latency Dashboard",
        "panels": [
          {
            "title": "p50 Latency",
            "targets": [
              {
                "expr": "histogram_quantile(0.5, sum by (le,job,route)(rate(http_request_duration_seconds_bucket[5m])))"
              }
            ],
            "type": "graph"
          },
          {
            "title": "p95 Latency",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, sum by (le,job,route)(rate(http_request_duration_seconds_bucket[5m])))"
              }
            ],
            "type": "graph"
          },
          {
            "title": "p99 Latency",
            "targets": [
              {
                "expr": "histogram_quantile(0.99, sum by (le,job,route)(rate(http_request_duration_seconds_bucket[5m])))"
              }
            ],
            "type": "graph",
            "thresholds": [
              {
                "value": 0.01,
                "color": "red"
              }
            ]
          },
          {
            "title": "Latency Heatmap by Service",
            "targets": [
              {
                "expr": "sum by (le,job)(rate(http_request_duration_seconds_bucket[5m]))"
              }
            ],
            "type": "heatmap"
          }
        ],
        "templating": {
          "list": [
            {
              "name": "service",
              "type": "query",
              "datasource": "Prometheus",
              "query": "label_values(http_requests_total, job)"
            },
            {
              "name": "endpoint",
              "type": "query",
              "datasource": "Prometheus",
              "query": "label_values(http_requests_total{job=~\"$service\"}, route)"
            }
          ]
        }
      }
    }
  throughput-dashboard.json: |
    {
      "dashboard": {
        "title": "Throughput Dashboard",
        "panels": [
          {
            "title": "Requests per Second by Service",
            "targets": [
              {
                "expr": "rate(http_requests_total[1m])"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Kafka Messages Published per Second",
            "targets": [
              {
                "expr": "rate(kafka_messages_published_total[1m])"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Kafka Messages Consumed per Second",
            "targets": [
              {
                "expr": "rate(kafka_messages_consumed_total[1m])"
              }
            ],
            "type": "graph"
          },
          {
            "title": "WebSocket Connections",
            "targets": [
              {
                "expr": "websocket_connections_total"
              }
            ],
            "type": "gauge"
          }
        ],
        "templating": {
          "list": [
            {
              "name": "service",
              "type": "query",
              "datasource": "Prometheus",
              "query": "label_values(http_requests_total, job)"
            },
            {
              "name": "topic",
              "type": "query",
              "datasource": "Prometheus",
              "query": "label_values(kafka_messages_published_total, topic)"
            }
          ]
        }
      }
    }
  error-dashboard.json: |
    {
      "dashboard": {
        "title": "Error Dashboard",
        "panels": [
          {
            "title": "Error Rate by Service",
            "targets": [
              {
                "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])"
              }
            ],
            "type": "graph",
            "thresholds": [
              {
                "value": 0.01,
                "color": "red"
              }
            ]
          },
          {
            "title": "Error Count by Status Code",
            "targets": [
              {
                "expr": "sum by (status) (rate(http_requests_total{status=~\"4..|5..\"}[5m]))"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Kafka Publish Errors",
            "targets": [
              {
                "expr": "rate(kafka_publish_errors_total[5m])"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Circuit Breaker State",
            "targets": [
              {
                "expr": "market_data_circuit_breaker_state"
              }
            ],
            "type": "gauge"
          }
        ]
      }
    }
  kafka-dashboard.json: |
    {
      "dashboard": {
        "title": "Kafka Dashboard",
        "panels": [
          {
            "title": "Consumer Lag by Topic",
            "targets": [
              {
                "expr": "kafka_consumer_lag"
              }
            ],
            "type": "graph",
            "thresholds": [
              {
                "value": 1000,
                "color": "red"
              }
            ]
          },
          {
            "title": "Consumer Lag Heatmap",
            "targets": [
              {
                "expr": "kafka_consumer_lag"
              }
            ],
            "type": "heatmap"
          },
          {
            "title": "Messages Published per Second",
            "targets": [
              {
                "expr": "rate(kafka_messages_published_total[1m])"
              }
            ],
            "type": "graph"
          },
          {
            "title": "Messages Consumed per Second",
            "targets": [
              {
                "expr": "rate(kafka_messages_consumed_total[1m])"
              }
            ],
            "type": "graph"
          }
        ]
      }
    }
